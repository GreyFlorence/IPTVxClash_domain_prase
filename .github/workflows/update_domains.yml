name: Update M3U Domains and IPs

on:
  schedule:
    - cron: '0 */6 * * *'  # 每 6 小时运行一次
  workflow_dispatch:  # 允许手动触发

jobs:
  update_domains_and_ips:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 下载多个 M3U 直播源
        run: |
          # 定义 M3U 链接
          m3u_urls=(
            "https://raw.githubusercontent.com/YueChan/Live/main/Global.m3u"
          )

          # 下载所有 M3U 文件
          for url in "${m3u_urls[@]}"; do
            curl -O $url
          done

      - name: 解析 M3U 获取域名和 IP
        run: |
          # 合并所有 M3U 文件内容，提取域名和 IP
          cat *.m3u | grep -Eo 'https?://[^"]+' | awk -F/ '{print $3}' | sort -u > all_hosts.txt
          
          # 提取 IP 和 域名
          grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' all_hosts.txt > ips.txt
          grep -Ev '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' all_hosts.txt > domains.txt

          # 生成 YAML 格式 - 域名
          echo "payload:" > domains.yml
          sed 's/^/  - "/; s/$/"/' domains.txt >> domains.yml

          # 生成 YAML 格式 - IP
          echo "payload:" > ips.yml
          sed 's/^/  - "/; s/$/"/' ips.txt >> ips.yml

      - name: 提交更改
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${PAT_TOKEN}@github.com/${{ github.repository }}.git
          git add domains.yml ips.yml
          git commit -m "Update domains and IPs from multiple M3U sources" || exit 0
          git push origin HEAD:main
