name: Update M3U Domains and IPs

on:
  schedule:
    - cron: '0 */6 * * *'  # 每 6 小时运行一次
  workflow_dispatch:  # 允许手动触发

jobs:
  update_domains_and_ips:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 下载多个 M3U 直播源
        run: |
          # 定义 M3U 直播源 URL 列表
          M3U_URLS=( 
            "https://raw.githubusercontent.com/YueChan/Live/main/Global.m3u"
          )
          
          # 下载所有的 M3U 直播源
          for url in "${M3U_URLS[@]}"; do
            curl -o playlist.m3u "$url"
            cat playlist.m3u >> combined_playlist.m3u
          done

      - name: 解析 M3U 获取域名和 IP
        run: |
          # 提取 URL
          grep -Eo 'https?://[^"]+' combined_playlist.m3u | awk -F/ '{print $3}' | sort -u > all_hosts.txt
          
          # 提取域名和 IP
          grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' all_hosts.txt > ips.txt
          grep -Ev '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' all_hosts.txt > domains.txt

          # 生成 YAML 格式
          echo "payload:" > domains.yml
          sed 's/^/  - "/; s/$/"/' domains.txt >> domains.yml

          echo "payload:" > ips.yml
          sed 's/^/  - "/; s/$/"/' ips.txt >> ips.yml

      - name: 提交更改
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add domains.yml ips.yml
          git commit -m "Update domains and IPs from multiple M3U sources" || exit 0
          git push origin HEAD:main
